<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hà Nội còn một chút này</title>

    <!-- Icon font (dùng cho các nút trên thanh công cụ) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <style>
        :root {
            --red-main: #b02022;
            --red-dark: #7c1517;
            --cream-bg: #f5e5c7;
            --paper-bg: #fff7e8;
            --note-bg: #fffaf0;
            --border-color: #d6b88a;
            --text-main: #3c2b22;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* GLOBAL SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #A52A2A;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8B1A1A;
        }

        /* For Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #A52A2A transparent;
        }

        html,
        body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Noto Serif", "Times New Roman", serif;
            background: var(--cream-bg);
            color: var(--text-main);
        }

        .app-shell {
            width: 100%;
            height: 100vh;
            background: #fdf3e3;
            border-left: 4px solid #e0c293;
            border-right: 4px solid #e0c293;
            display: grid;
            grid-template-columns: 297px minmax(0, 1fr) 260px;
            transition: grid-template-columns 0.25s ease;
            overflow: hidden;
        }

        /* LEFT SIDEBAR */
        .left-sidebar {
            border-right: 2px solid #e0c293;
            background: #f9e7c8;
            display: flex;
            flex-direction: column;
            min-width: 297px;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #A52A2A transparent;
        }

        .left-sidebar::-webkit-scrollbar {
            width: 5px;
        }

        .left-sidebar::-webkit-scrollbar-track {
            background: #f9e7c8;
        }

        .left-sidebar::-webkit-scrollbar-thumb {
            background: #A52A2A;
            border-radius: 10px;
        }

        .left-sidebar::-webkit-scrollbar-thumb:hover {
            background: #8B1A1A;
        }

        .book-cover {
            display: flex;
            justify-content: center;
        }

        .book-cover img {
            width: 246px;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            object-fit: contain;
        }

        .toc-wrapper {
            padding: 10px 18px 24px;
            background: #fdf0d7;
            flex: 1;
        }

        .toc-title {
            font-family: "Playfair Display", "Times New Roman", serif;
            font-size: 24px;
            text-align: center;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .toc-section-title {
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: 16px;
            letter-spacing: 0.1em;
            font-weight: 800;
            color: #632d2d;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(99, 45, 45, 0.1);
            padding-bottom: 4px;
        }

        .toc-list {
            list-style: none;
            margin: 4px 0 6px 0;
        }

        .toc-list li {
            font-size: 16px;
            margin: 4px 0;
        }

        .toc-list a {
            text-decoration: none;
            color: #4a3b2d;
        }

        .toc-list a:hover {
            color: var(--red-main);
        }

        .toc-list li {
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .toc-list li:hover {
            color: var(--red-main);
        }

        /* Cấp 1: Chương */
        .toc-chapter {
            position: relative;
        }

        .toc-chapter-title {
            font-weight: 700;
            color: #4a3b2d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 0.02em;
        }

        .toc-chapter-title:hover {
            color: var(--red-main);
        }

        .toc-chapter-title .chevron {
            font-size: 10px;
            transition: transform 0.3s ease;
            color: #d6b88a;
            margin-right: 5px;
        }

        .toc-chapter.expanded .chevron {
            transform: rotate(90deg);
        }

        /* Cấp 2: Các phần trong chương */
        .toc-sub-list {
            list-style: none;
            margin: 0 0 8px 16px;
            padding-left: 12px;
            border-left: 2px solid #d6b88a;
            display: none;
        }

        .toc-chapter.expanded .toc-sub-list {
            display: block;
        }

        .toc-section {
            font-size: 14px;
            color: #6b5d4a;
            padding: 4px 0;
            margin: 2px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.4;
        }

        .toc-section:hover {
            color: var(--red-main);
            padding-left: 4px;
        }

        /* Highlight chương được tìm thấy */
        .toc-list li.search-active {
            background: #ffdd71;
            padding: 4px 8px;
            margin: 2px -8px;
            border-radius: 4px;
            animation: pulse-highlight 0.5s ease-in-out 3;
        }

        @keyframes pulse-highlight {

            0%,
            100% {
                background: #ffdd71;
            }

            50% {
                background: #ffe9a0;
            }
        }

        body.dark-theme .toc-list li.search-active {
            background: #f5c86b;
            color: #222;
        }

        /* CENTER COLUMN */
        .center-column {
            background: var(--paper-bg);
            display: flex;
            flex-direction: column;
            border-left: 2px solid #f2d9af;
            border-right: 2px solid #f2d9af;
            height: 100vh;
            overflow: hidden;
        }

        /* TOP TOOLBAR */
        .top-toolbar {
            background: var(--red-main);
            padding: 10px 22px;
            display: flex;
            align-items: center;
            width: 100%;
            border-radius: 10px;
            margin: 16px auto;
            justify-content: space-between;
            color: white;
        }

        .top-toolbar .search-box {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border-radius: 999px;
            padding: 4px 16px;
            width: 230px;
            position: relative;
        }

        .top-toolbar .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 13px;
            height: 24px;
        }

        /* Search Dropdown */
        #searchDropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 320px;
            background: #fffdf8;
            border: 1px solid #d6c7a8;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
            max-height: 320px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #searchDropdown.show {
            display: block;
        }

        .search-result-section {
            padding: 6px 14px 4px;
            font-size: 11px;
            color: #888;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: #f9f3e8;
            border-bottom: 1px solid #e8dcc4;
        }

        .search-result-item {
            padding: 10px 14px 10px 24px;
            cursor: pointer;
            font-size: 13px;
            color: #4a3b2d;
            border-bottom: 1px solid #f0e6d6;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #f5e5c7;
        }

        .search-result-item i {
            font-size: 11px;
            color: var(--red-main);
        }

        .search-highlight {
            background: #ffdd71;
            padding: 0 2px;
            border-radius: 2px;
        }

        .search-no-result {
            padding: 16px 14px;
            font-size: 13px;
            color: #888;
            text-align: center;
        }

        /* Dark theme for search dropdown */
        body.dark-theme #searchDropdown {
            background: #2b2b2b;
            border-color: #444444;
        }

        body.dark-theme .search-result-section {
            background: #333333;
            border-bottom-color: #444444;
            color: #aaa;
        }

        body.dark-theme .search-result-item {
            color: #f5f5f5;
            border-bottom-color: #3a3a3a;
        }

        body.dark-theme .search-result-item:hover {
            background: #3a3a3a;
        }

        body.dark-theme .search-highlight {
            background: #f5c86b;
            color: #222;
        }

        body.dark-theme .search-no-result {
            color: #888;
        }

        .top-toolbar .icons {
            display: flex;
            gap: 10px;
            font-size: 14px;
            align-items: center;
        }

        .top-toolbar .icon-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.06);
            color: #fff7e8;
            font-size: 12px;
            cursor: pointer;
        }

        .top-toolbar .icon-btn i {
            font-size: 13px;
        }

        .top-toolbar .icon-btn.active {
            background: #fff7e8;
            color: var(--red-main);
        }

        /* Nút toggle cho highlight */
        .top-toolbar .icon-toggle {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.06);
            color: #fff7e8;
            cursor: pointer;
            font-size: 13px;
        }

        .top-toolbar .icon-toggle.active {
            background: #fff7e8;
            color: var(--red-main);
        }

        .title-block {
            text-align: center;
            padding: 18px 24px 10px;
            padding-top: 0px;
        }

        .book-title {
            font-family: "Playfair Display", "Times New Roman", serif;
            font-size: 30px;
            color: var(--red-main);
            letter-spacing: 0.05em;
        }

        .book-author {
            display: inline-block;
            background: #f5c95b;
            padding: 6px 24px;
            border-radius: 999px;
            font-size: 13px;
        }

        /* ARTICLE HEADER */
        .article-wrapper {
            padding: 18px 40px 26px;
            flex: 1;
            overflow-y: auto;
            /* Thay thế calc height cứng bằng flex: 1 để tự co giãn */
        }

        .article-heading-row {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            margin-bottom: 12px;
            gap: 3px;

        }

        .article-heading-chip {
            display: inline-block;
            background: var(--red-main);
            color: white;
            padding: 5px 14px;
            height: 30px;
            transition: all 0.3s ease;
        }

        .heading-animate {
            animation: headingFadeIn 0.5s ease;
        }

        @keyframes headingFadeIn {
            0% {
                opacity: 0.5;
                transform: translateX(-10px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .article-content {
            font-size: 22px;
            line-height: 1.8;
            text-align: justify;
        }

        /* Ẩn H1, H2 nội bộ trong nội dung chương (đã có tiêu đề riêng ở ngoài) */
        .article-content h1,
        .article-content h2 {
            display: none;
        }

        .article-content p+p {
            margin-top: 10px;
        }

        .article-image {
            text-align: center;
            margin: 18px 0;
        }

        .article-image img {
            max-width: 246px;
            width: 100%;
            border-radius: 4px;
            border: 2px solid #ccc;
        }

        /* CHAPTER NAVIGATION BUTTONS */
        .chapter-nav-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--red-main);
            background: rgba(255, 255, 255, 0.95);
            color: var(--red-main);
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chapter-nav-btn:hover {
            background: var(--red-main);
            color: white;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(176, 32, 34, 0.3);
        }

        .chapter-nav-btn.prev {
            left: calc(297px + 24px);
        }

        .chapter-nav-btn.next {
            right: calc(260px + 24px);
        }

        .chapter-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            box-shadow: none;
        }

        .chapter-nav-btn:disabled:hover {
            background: rgba(255, 255, 255, 0.95);
            color: var(--red-main);
            transform: translateY(-50%);
            box-shadow: none;
        }

        /* Fullscreen mode: điều chỉnh vị trí */
        body.fullscreen-mode .chapter-nav-btn.prev {
            left: calc(280px + 24px);
        }

        body.fullscreen-mode .chapter-nav-btn.next {
            right: 24px;
        }

        /* Khi sidebar trái thu gọn */
        body.toc-collapsed .chapter-nav-btn.prev {
            left: calc(40px + 24px);
        }

        /* Dark theme */
        body.dark-theme .chapter-nav-btn {
            background: rgba(40, 40, 40, 0.95);
            border-color: #f5c86b;
            color: #f5c86b;
        }

        body.dark-theme .chapter-nav-btn:hover {
            background: #f5c86b;
            color: #222;
        }

        /* Chương đang active trong mục lục */
        .toc-list li.toc-active,
        .toc-chapter.toc-active .toc-chapter-title,
        .toc-section.toc-active {
            color: var(--red-main);
            font-weight: 600;
        }

        body.dark-theme .toc-list li.toc-active,
        body.dark-theme .toc-chapter.toc-active .toc-chapter-title,
        body.dark-theme .toc-section.toc-active {
            color: #f5c86b;
        }

        /* SCROLL TO TOP BUTTON */
        .scroll-top-btn {
            position: fixed;
            bottom: 90px;
            right: calc(260px + 30px);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--red-main);
            background: rgba(255, 255, 255, 0.95);
            color: var(--red-main);
            font-size: 18px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* CHAPTER INTRO PAGE */
        .chapter-intro-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 500px;
            text-align: center;
            padding: 60px 40px;
            animation: fadeIn 1s ease-out;
        }

        .chapter-intro-num {
            font-family: "Playfair Display", serif;
            font-size: 48px;
            font-weight: 700;
            color: #000;
            letter-spacing: 0.12em;
            margin-bottom: 16px;
            text-transform: uppercase;
        }

        .chapter-intro-title {
            font-family: "Merriweather", serif;
            font-size: 28px;
            font-weight: 400;
            color: #000;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            max-width: 85%;
            line-height: 1.4;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scroll-top-btn.show {
            opacity: 1;
            visibility: visible;
        }

        .scroll-top-btn:hover {
            background: var(--red-main);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(176, 32, 34, 0.3);
        }

        /* Fullscreen mode */
        body.fullscreen-mode .scroll-top-btn {
            right: 30px;
        }

        /* Khi sidebar trái thu gọn */
        body.toc-collapsed .scroll-top-btn {
            right: calc(260px + 30px);
        }

        /* Dark theme */
        body.dark-theme .scroll-top-btn {
            background: rgba(40, 40, 40, 0.95);
            border-color: #f5c86b;
            color: #f5c86b;
        }

        body.dark-theme .scroll-top-btn:hover {
            background: #f5c86b;
            color: #222;
        }

        /* BOTTOM PROGRESS */
        .bottom-progress {
            border-top: 1px solid #e4cfaa;
            padding: 8px 20px 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #7a6651;
            background: #fdf8f0;
            /* Luôn dính phía dưới vùng đọc ở cột giữa */
            position: sticky;
            bottom: 0;
            z-index: 5;
        }

        .progress-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--red-main);
            background: transparent;
            color: var(--red-main);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .progress-nav-btn:hover {
            background: var(--red-main);
            color: white;
        }

        .progress-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .progress-nav-btn:disabled:hover {
            background: transparent;
            color: var(--red-main);
        }

        .bottom-progress .bar {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: #ebddc2;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: height 0.2s ease;
        }

        .bottom-progress .bar:hover {
            height: 10px;
        }

        .bottom-progress .bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--red-main), #e04040);
            border-radius: 999px;
            transition: width 0.15s ease;
        }

        .scroll-progress-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--red-main);
            min-width: 45px;
            text-align: center;
        }

        /* Dark theme for progress */
        body.dark-theme .bottom-progress {
            border-top-color: #444444;
            background: #252525;
        }

        body.dark-theme .progress-nav-btn {
            border-color: #f5c86b;
            color: #f5c86b;
        }

        body.dark-theme .progress-nav-btn:hover {
            background: #f5c86b;
            color: #222;
        }

        body.dark-theme .bottom-progress .bar {
            background: #3a3a3a;
        }

        body.dark-theme .bottom-progress .bar-fill {
            background: linear-gradient(90deg, #f5c86b, #ffd700);
        }

        body.dark-theme .scroll-progress-text {
            color: #f5c86b;
        }

        /* RIGHT SIDEBAR */
        .right-sidebar {
            background: #fdf3e3;
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-left: 2px solid #e0c293;
            height: 100vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #A52A2A transparent;
        }

        .right-sidebar::-webkit-scrollbar {
            width: 5px;
        }

        .right-sidebar::-webkit-scrollbar-track {
            background: #fdf3e3;
        }

        .right-sidebar::-webkit-scrollbar-thumb {
            background: #A52A2A;
            border-radius: 10px;
        }

        .right-sidebar::-webkit-scrollbar-thumb:hover {
            background: #8B1A1A;
        }

        /* Tabs row */
        .sidebar-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 6px;
            justify-content: center;
            gap: 5px;
            padding: 0 10px;
        }

        .sidebar-tabs .tab-item {
            padding: 10px;
            font-size: 13px;
            cursor: pointer;
            width: max-content;
            background-color: transparent;
            border-radius: 4px 4px 0 0;
            white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #7a6651;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.02em;
            font-weight: 700;
        }

        .sidebar-tabs .tab-item.active {
            font-weight: 700;
            color: #A52A2A;
            border-bottom: 2px solid #A52A2A;
        }

        .sidebar-tabs .tab-item:hover {
            color: #A52A2A;
            background-color: rgba(165, 42, 42, 0.02);
            border-bottom-color: rgba(165, 42, 42, 0.3);
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        /* Notes list */
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .note-item {
            background: #fff;
            border: 1px solid #e8dcc4;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            line-height: 1.8;
            color: #4a3b2d;
            position: relative;
            transition: all 0.2s;
        }

        .note-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .note-item-preview {
            color: #7a6651;
            font-size: 11px;
            margin-bottom: 6px;
            font-style: italic;
        }

        .note-item-content {
            color: #4a3b2d;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .note-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid #f0e8d8;
        }

        .note-item-time {
            font-size: 10px;
            color: #9a8a7a;
        }

        .note-item-actions {
            display: flex;
            gap: 4px;
        }

        .note-item-actions button {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #7a6651;
            transition: all 0.2s;
        }

        .note-item-actions button:hover {
            background: #f5efe5;
            color: #4a3b2d;
        }

        /* Note form */
        .note-form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .note-form {
            background: #fffdf8;
            border-radius: 12px;
            border: 1px solid #d6c7a8;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .note-form-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e8dcc4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-form-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #4a3b2d;
        }

        .note-form-header .close-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7a6651;
            transition: all 0.2s;
        }

        .note-form-header .close-btn:hover {
            background: #f5efe5;
            color: #4a3b2d;
        }

        .note-form-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #4a3b2d;
            margin-bottom: 6px;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d6c7a8;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            color: #4a3b2d;
            background: #fff;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group textarea:focus {
            border-color: #c4a876;
            box-shadow: 0 0 0 2px rgba(196, 168, 118, 0.1);
        }

        .form-group textarea[readonly] {
            background: #f9f5f0;
            cursor: text;
            padding-right: 90px;
        }

        .form-group textarea[readonly]:focus {
            background: #fff;
        }

        #selectTextBtn {
            transition: all 0.2s;
        }

        #selectTextBtn:hover {
            background: #f5efe5 !important;
            border-color: #c4a876 !important;
            color: #4a3b2d !important;
        }

        body.dark-theme .form-group textarea[readonly] {
            background: #252525;
        }

        body.dark-theme .form-group textarea[readonly]:focus {
            background: #1a1a1a;
        }

        .note-form-footer {
            padding: 16px 20px;
            border-top: 1px solid #e8dcc4;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .note-form-footer button {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
        }

        .note-form-footer .btn-cancel {
            background: #fff;
            border-color: #d6c7a8;
            color: #7a6651;
        }

        .note-form-footer .btn-cancel:hover {
            background: #f5efe5;
            border-color: #c4a876;
            color: #4a3b2d;
        }

        .note-form-footer .btn-save {
            background: #4a3b2d;
            border-color: #4a3b2d;
            color: #fff;
        }

        .note-form-footer .btn-save:hover {
            background: #5a4b3d;
            border-color: #5a4b3d;
        }

        /* Dark theme for note form */
        body.dark-theme .note-form {
            background: #2d2d2d;
            border-color: #444;
        }

        body.dark-theme .note-form-header {
            border-bottom-color: #444;
        }

        body.dark-theme .note-form-header h3 {
            color: #f5f5f5;
        }

        body.dark-theme .form-group label {
            color: #f5f5f5;
        }

        body.dark-theme .form-group textarea {
            background: #1a1a1a;
            border-color: #444;
            color: #f5f5f5;
        }

        body.dark-theme .form-group textarea:focus {
            border-color: #666;
        }

        body.dark-theme .note-form-footer {
            border-top-color: #444;
        }

        body.dark-theme .note-form-footer .btn-cancel {
            background: #1a1a1a;
            border-color: #444;
            color: #ccc;
        }

        body.dark-theme .note-form-footer .btn-cancel:hover {
            background: #2a2a2a;
        }

        /* Annotations list */
        .annotations-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .annotation-item {
            background: #fff;
            border: 1px solid #e8dcc4;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            line-height: 1.8;
            color: #4a3b2d;
            position: relative;
            transition: all 0.2s;
        }

        .annotation-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .annotation-item-related {
            background: #f9f5f0;
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 11px;
            color: #7a6651;
            border-left: 3px solid #d6c7a8;
        }

        .annotation-item-content {
            color: #4a3b2d;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .annotation-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid #f0e8d8;
        }

        .annotation-item-time {
            font-size: 10px;
            color: #9a8a7a;
        }

        .annotation-item-actions {
            display: flex;
            gap: 4px;
        }

        .annotation-item-actions button {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #7a6651;
            transition: all 0.2s;
        }

        .annotation-item-actions button:hover {
            background: #f5efe5;
            color: #4a3b2d;
        }

        /* Note cards */
        .note-card {
            background: #fffdf8;
            border-radius: 8px;
            border: 1px solid #d6c7a8;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 100px;
        }

        .note-card-header {
            padding: 8px 12px;
            border-bottom: 1px solid #e8dcc4;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 600;
            color: #4a3b2d;
        }

        .note-card-header button {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid #d6c7a8;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            color: #7a6651;
        }

        .note-card-header button:hover {
            background: #f5efe5;
        }

        .note-card-body {
            padding: 10px 12px;
            flex: 1;
            overflow-y: auto;
        }

        .note-content {
            font-size: 12px;
            line-height: 1.8;
            color: #4a3b2d;
        }

        .note-content .highlight-word {
            background: #ffe58f;
            padding: 0 2px;
        }

        .note-content .red-text {
            color: var(--red-main);
        }

        .note-textarea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            background: transparent;
            font-family: inherit;
            font-size: 12px;
            line-height: 1.8;
            outline: none;
            color: #4a3b2d;
        }

        /* Highlight trong nội dung */
        .highlight-mark {
            background-color: #ffdd71;
            padding: 0 2px;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .highlight-mark:hover {
            opacity: 0.8;
        }

        /* Highlight colors */
        .highlight-mark.color-yellow {
            background-color: #ffdd71;
        }

        .highlight-mark.color-blue {
            background-color: #a8d5ff;
        }

        .highlight-mark.color-pink {
            background-color: #ffb3d9;
        }

        .highlight-mark.color-green {
            background-color: #b3ffb3;
        }

        .highlight-mark.color-orange {
            background-color: #ffcc99;
        }

        .highlight-mark-active {
            animation: highlightPulse 1s ease-in-out;
        }

        @keyframes highlightPulse {

            0%,
            100% {
                background-color: inherit;
            }

            50% {
                background-color: rgba(255, 255, 0, 0.5);
            }
        }

        /* Popup chọn highlight/ghi chú */
        .highlight-popup {
            position: absolute;
            background: #fffdf8;
            border: 1px solid #d6c7a8;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 10px;
            font-size: 12px;
            z-index: 9999;
            width: 220px;
        }

        .highlight-popup h4 {
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .highlight-popup .option-row {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
            align-items: center;
        }

        .highlight-popup textarea {
            width: 100%;
            min-height: 40px;
            border-radius: 4px;
            border: 1px solid #d6c7a8;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 12px;
            resize: vertical;
            margin-top: 4px;
            box-sizing: border-box;
        }

        .highlight-popup .btn-row {
            margin-top: 6px;
            display: flex;
            justify-content: flex-end;
            gap: 6px;
        }

        .highlight-popup button {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #d6c7a8;
            cursor: pointer;
            background: #f5efe5;
        }

        .highlight-popup button.primary {
            background: var(--red-main);
            color: #fffdf8;
            border-color: var(--red-main);
        }

        /* Item trong sidebar cho highlight/ghi chú */
        .sidebar-highlight-item {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e8dcc4;
            background: #fff;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-highlight-item:hover {
            border-color: #d6c7a8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-highlight-item .preview {
            font-size: 12px;
            color: #4a3b2d;
            margin-bottom: 6px;
            line-height: 1.8;
            padding-right: 24px;
        }

        .sidebar-highlight-item .note-text {
            font-size: 11px;
            color: #7a6651;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #f0e8d8;
        }

        .sidebar-highlight-item .highlight-color-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-highlight-item .highlight-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #f0e8d8;
        }

        .sidebar-highlight-item .highlight-actions button {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #7a6651;
            transition: all 0.2s;
        }

        .sidebar-highlight-item .highlight-actions button:hover {
            background: #f5efe5;
            color: #4a3b2d;
        }

        .sidebar-highlight-item .highlight-time {
            font-size: 10px;
            color: #9a8a7a;
            margin-top: 4px;
        }

        /* Chatbot panel */
        #chatPanel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 340px;
            height: 420px;
            background: #fffdf8;
            border: 1px solid #d6c7a8;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 10000;
        }

        #chatPanelHeader {
            padding: 8px 10px;
            border-bottom: 1px solid #e0c293;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 600;
            background: #f4e3c5;
        }

        #chatPanelHeader button {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
        }

        #chatMessages {
            flex: 1;
            padding: 8px 10px;
            overflow-y: auto;
            font-size: 12px;
        }

        .chat-message {
            margin-bottom: 6px;
            max-width: 90%;
            padding: 6px 8px;
            border-radius: 8px;
        }

        .chat-message.user {
            background: #ffe4b5;
            margin-left: auto;
        }

        .chat-message.bot {
            background: #f0f0f0;
            margin-right: auto;
        }

        #chatInputArea {
            padding: 6px 8px;
            border-top: 1px solid #e0c293;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #chatInput {
            width: 100%;
            min-height: 50px;
            max-height: 90px;
            resize: vertical;
            border-radius: 6px;
            border: 1px solid #d6c7a8;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 12px;
            box-sizing: border-box;
        }

        #chatSendBtn {
            align-self: flex-end;
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--red-main);
            background: var(--red-main);
            color: #fffdf8;
            cursor: pointer;
        }

        /* Dark theme for chat */
        body.dark-theme #chatPanel {
            background: #222222;
            border-color: #444444;
        }

        body.dark-theme #chatPanelHeader {
            background: #333333;
            border-bottom-color: #444444;
            color: #f5f5f5;
        }

        body.dark-theme #chatMessages {
            color: #f5f5f5;
        }

        body.dark-theme .chat-message.user {
            background: #62402a;
        }

        body.dark-theme .chat-message.bot {
            background: #333333;
        }

        body.dark-theme #chatInputArea {
            border-top-color: #444444;
        }

        body.dark-theme #chatInput {
            background: #2b2b2b;
            border-color: #555555;
            color: #f5f5f5;
        }

        /* Dark theme overrides */
        body.dark-theme {
            background: #181818;
            color: #f5f5f5;
        }

        body.dark-theme .app-shell {
            border-left-color: #3a2a1a;
            border-right-color: #3a2a1a;
        }

        body.dark-theme .center-column {
            background: #222222;
        }

        body.dark-theme .left-sidebar {
            background: #252525;
            border-right-color: #3a2a1a;
        }

        body.dark-theme .right-sidebar {
            background: #252525;
        }

        body.dark-theme .toc-wrapper {
            background: #2d2d2d;
        }

        body.dark-theme .title-block {
            background: #252525;
            border-bottom-color: #3a2a1a;
        }

        body.dark-theme .top-toolbar {
            background: #8b1b1d;
        }

        body.dark-theme .note-card {
            background: #2b2b2b;
            border-color: #444444;
        }

        body.dark-theme .note-card-header {
            background: #333333;
            border-bottom-color: #444444;
        }

        body.dark-theme .note-card-header button {
            background: #2b2b2b;
            border-color: #555555;
            color: #e5e5e5;
        }

        body.dark-theme .note-card-body {
            color: #f5f5f5;
        }

        body.dark-theme .highlight-mark {
            background-color: #f5c86b;
        }

        body.dark-theme .bottom-progress {
            border-top-color: #444444;
            color: #cfcfcf;
        }

        body.dark-theme .bottom-progress .bar {
            background: #3a3a3a;
        }

        /* =====================
           FULLSCREEN MODE
        ===================== */
        /* Ẩn sidebar phải khi fullscreen */
        body.fullscreen-mode .right-sidebar {
            display: none;
        }

        /* Grid chỉ còn 2 cột: sidebar trái + nội dung */
        body.fullscreen-mode .app-shell {
            grid-template-columns: 280px minmax(0, 1fr);
        }

        /* Ảnh trong bài float phải, text wrap quanh */
        body.fullscreen-mode .article-image {
            float: right;
            margin: 0 0 16px 24px;
            max-width: 320px;
            text-align: center;
        }

        body.fullscreen-mode .article-content::after {
            content: '';
            display: block;
            clear: both;
        }

        /* Tên sách ở giữa toolbar khi fullscreen */
        .book-title-toolbar {
            display: none;
            font-size: 16px;
            font-weight: 600;
            color: #fff7e8;
            letter-spacing: 0.02em;
        }

        body.fullscreen-mode .book-title-toolbar {
            display: block;
        }

        /* Ẩn title block dưới toolbar khi fullscreen để gọn hơn */
        body.fullscreen-mode .title-block {
            display: none;
        }

        /* Nội dung chiếm nhiều không gian hơn */
        body.fullscreen-mode .article-wrapper {
            padding: 24px 48px 32px;
        }

        /* Article heading chip style cho fullscreen */
        body.fullscreen-mode .article-heading-row {
            margin-bottom: 20px;
        }

        body.fullscreen-mode .article-heading-chip {
            font-size: 20px;
            padding: 8px 20px;
        }

        @media (max-width: 1024px) {
            .app-shell {
                grid-template-columns: 220px minmax(0, 1fr);
            }

            .right-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app-shell {
                grid-template-columns: minmax(0, 1fr);
            }

            .left-sidebar {
                display: none;
            }
        }

        /* Toggle icon (đóng/mở mục lục) */
        .icon-dongmomenu {
            width: 100%;
            height: 28px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            padding: 6px 10px 0;
            color: var(--red-main);
            cursor: pointer;
            font-size: 12px;
        }

        .icon-dongmomenu i {
            padding: 4px;
            border-radius: 50%;
        }

        /* Mặc định: chỉ hiện mũi tên trái (thu gọn) */
        .icon-dongmomenu .icon-left {
            display: inline-block;
        }

        .icon-dongmomenu .icon-right {
            display: none;
        }

        /* Trạng thái thu gọn mục lục bên trái */
        body.toc-collapsed .app-shell {
            grid-template-columns: 40px minmax(0, 1fr) 260px;
        }

        body.toc-collapsed .left-sidebar {
            border-right: none;
            overflow: hidden;
        }

        /* Ẩn hết phần nội dung mục lục khi thu gọn, chỉ giữ lại nút toggle */
        body.toc-collapsed .left-sidebar .book-cover,
        body.toc-collapsed .left-sidebar .icon-down,
        body.toc-collapsed .left-sidebar .line,
        body.toc-collapsed .left-sidebar .toc-wrapper {
            display: none;
        }

        body.toc-collapsed .left-sidebar .icon-dongmomenu {
            display: flex;
            justify-content: center;
        }

        /* Khi thu gọn: chỉ hiện mũi tên phải (mở rộng lại) */
        body.toc-collapsed .icon-dongmomenu .icon-left {
            display: none;
        }

        body.toc-collapsed .icon-dongmomenu .icon-right {
            display: inline-block;
        }

        .line {
            width: 90%;
            height: 5px;
            background: #f3b147;
            margin: 0 auto;
        }

        .icon-down {
            width: 100%;
            height: 20px;
            display: flex;
            justify-content: end;
            align-items: flex-end;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            /* margin-left: 10px; */
        }

        .top-block {
            width: 100%;
            background: #ffffff;
            margin: 0 auto;
        }

        .line-article {
            width: 3px;
            height: 30px;
            background: var(--red-main);
        }
    </style>
</head>

<body>
    <div class="app-shell">
        <!-- LEFT SIDEBAR -->
        <aside class="left-sidebar">
            <div class="icon-dongmomenu">
                <i class="fa-solid fa-chevron-left icon-left"></i>
                <i class="fa-solid fa-chevron-right icon-right"></i>
            </div>
            <div class="book-cover">
                <!-- Ảnh bìa chính lấy từ thư mục asset/images -->
                <img src="asset/images/Bia1.jpg" alt="Bìa sách Hà Nội còn một chút này" style="object-fit: contain;" />
            </div>
            <div class="icon-down">
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="line">

            </div>
            <div class="toc-wrapper">
                <div class="toc-title">Mục lục</div>
                <div id="tocContent"></div>
            </div>
        </aside>

        <!-- CENTER COLUMN -->
        <main class="center-column">
            <!-- TOP TOOLBAR -->
            <div class="top-block">
                <div style="padding: 0 40px;">
                    <div class="top-toolbar">
                        <div class="search-box">
                            <i class="fa-solid fa-magnifying-glass" style="font-size: 12px; color: #b0a093;"></i>
                            <input type="text" id="searchInput" placeholder="Tìm kiếm chương..." />
                            <div id="searchDropdown"></div>
                        </div>
                        <span class="book-title-toolbar">Hà Nội còn một chút này</span>
                        <div class="icons">
                            <button id="audioBtn" class="icon-btn" type="button">
                                <i class="fa-solid fa-headphones"></i>
                                <span>Audio</span>
                            </button>
                            <button id="highlightModeBtn" class="icon-toggle" type="button"
                                title="Chế độ đánh dấu / ghi chú">
                                <i class="fa-solid fa-highlighter"></i>
                            </button>
                            <button id="themeToggleBtn" class="icon-toggle" type="button" title="Chế độ tối">
                                <i class="fa-solid fa-moon"></i>
                            </button>
                            <button id="chatToggleBtn" class="icon-toggle" type="button" title="Chatbot">
                                <i class="fa-solid fa-comments"></i>
                            </button>
                            <button id="fullscreenBtn" class="icon-toggle" type="button" title="Toàn màn hình">
                                <i class="fa-solid fa-expand"></i>
                            </button>
                            <i class="fa-solid fa-gear"></i>
                        </div>
                    </div>
                </div>

                <!-- TITLE -->
                <div class="title-block">
                    <div class="book-title">HÀ NỘI CÒN MỘT CHÚT NÀY</div>
                    <div class="book-author">Tác giả: Nguyễn Ngọc Tiến</div>
                </div>
            </div>

            <!-- ARTICLE CONTENT -->
            <div class="article-wrapper">
                <div class="article-heading-row">
                    <div class="line-article"></div>
                    <span class="article-heading-chip"></span>
                </div>

                <div class="article-content">
                    <p>
                        Thăng Long là trung tâm thương mại lớn nhất Đại Việt. Thăng Long cũng là nơi đến của các nhà
                        buôn, khách du lịch nước ngoài nên ít nhiều chịu ảnh hưởng của nhiều nền văn hóa, nhất là ở
                        giới nhà giàu. Ngày thường những người giàu có ăn mặc đã khác dân thường, ngày Tết họ lại càng
                        sang trọng và cầu kỳ hơn.
                    </p>

                    <div class="article-image">
                        <!-- Ảnh minh hoạ tạm -->
                        <img src="asset/image/Ảnh 2.jpeg" alt="Ảnh minh họa trang phục Tết" />
                    </div>

                    <p>
                        Trang phục của cánh đàn ông giàu có ở Thăng Long có điểm chung là “quần chúng áo dài”.
                        Theo quan niệm Nho giáo, quần dài đến mắt cá chân, áo dài đến nửa bàn tay sẽ che kín được
                        những khiếm khuyết bên trong, và cũng vì trang phục lung thung như vậy nên khi đi, đứng, ngồi
                        họ luôn phải giữ gìn tư thế.
                    </p>
                    <p>
                        Vào dịp Tết, màu sắc trang phục càng rực rỡ, vải vóc đắt tiền hơn, thể hiện cả sự sung túc
                        lẫn mong ước một năm mới hanh thông. Những bộ áo dài gấm đỏ sẫm, vàng nghệ, xanh biếc cùng
                        khăn xếp, giày thêu đã trở thành hình ảnh quen thuộc trên các con phố cổ Hà Nội mỗi độ xuân
                        về.
                    </p>
                </div>
            </div>

            <!-- CHAPTER NAVIGATION BUTTONS -->
            <button id="prevChapterBtn" class="chapter-nav-btn prev" title="Chương trước">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <button id="nextChapterBtn" class="chapter-nav-btn next" title="Chương sau">
                <i class="fa-solid fa-chevron-right"></i>
            </button>

            <!-- SCROLL TO TOP BUTTON -->
            <button id="scrollTopBtn" class="scroll-top-btn" title="Về đầu chương">
                <i class="fa-solid fa-chevron-up"></i>
            </button>

            <!-- Nhạc nền (ẩn) -->
            <audio id="bgMusic" src="asset/audio/nhac-khong-loi.mp3" loop></audio>

            <!-- BOTTOM PROGRESS -->
            <div class="bottom-progress">
                <button id="progressPrevBtn" class="progress-nav-btn" title="Chương trước">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <div class="bar" id="progressBar" title="Click để nhảy đến vị trí">
                    <div class="bar-fill" id="barFill"></div>
                </div>
                <span class="scroll-progress-text" id="scrollProgressText">0%</span>
                <button id="progressNextBtn" class="progress-nav-btn" title="Chương sau">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </main>

        <!-- RIGHT SIDEBAR -->
        <aside class="right-sidebar">
            <!-- Tabs -->
            <div class="sidebar-tabs">
                <div class="tab-item active" data-tab="notes">Ghi chú</div>
                <div class="tab-item" data-tab="highlights">Đánh dấu</div>
                <div class="tab-item" data-tab="annotations">Chú thích</div>
            </div>

            <!-- Ghi chú card -->
            <div class="note-card" id="notesCard">
                <div class="note-card-header">
                    <span>Ghi chú</span>
                    <button id="addNoteBtn" title="Thêm ghi chú mới">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <div class="note-card-body">
                    <div id="notesList" class="notes-list">
                        <div class="empty-state" id="notesEmptyState">
                            <i class="fa-regular fa-note-sticky"
                                style="font-size: 32px; color: #d6c7a8; margin-bottom: 8px;"></i>
                            <p style="font-size: 12px; color: #7a6651; text-align: center;">Chưa có ghi chú nào.</p>
                            <p style="font-size: 11px; color: #9a8a7a; text-align: center; margin-top: 4px;">Nhấn nút +
                                để thêm ghi chú mới</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Đánh dấu card -->
            <div class="note-card" id="highlightsCard" style="display: none;">
                <div class="note-card-header">
                    <span>Đánh dấu</span>
                    <div style="display: flex; gap: 4px;">
                        <button id="filterHighlightsBtn" title="Lọc theo màu">
                            <i class="fa-solid fa-filter"></i>
                        </button>
                    </div>
                </div>
                <div class="note-card-body">
                    <div id="highlightList"></div>
                </div>
            </div>

            <!-- Chú thích card -->
            <div class="note-card" id="annotationsCard" style="display: none;">
                <div class="note-card-header">
                    <span>Chú thích</span>
                    <button id="addAnnotationBtn" title="Thêm chú thích mới">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <div class="note-card-body">
                    <div id="annotationsList" class="annotations-list">
                        <div class="empty-state" id="annotationsEmptyState">
                            <i class="fa-regular fa-comment"
                                style="font-size: 32px; color: #d6c7a8; margin-bottom: 8px;"></i>
                            <p style="font-size: 12px; color: #7a6651; text-align: center;">Chưa có chú thích nào.</p>
                            <p style="font-size: 11px; color: #9a8a7a; text-align: center; margin-top: 4px;">Nhấn nút +
                                để thêm chú thích mới</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Chatbot Panel -->
    <div id="chatPanel">
        <div id="chatPanelHeader">
            <span>Chatbot</span>
            <button id="chatCloseBtn" type="button" title="Đóng">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="chatMessages">
            <div class="chat-message bot">
                Chào bạn, mình là chatbot hỗ trợ đọc sách. Bạn có thể hỏi tóm tắt đoạn này, giải nghĩa từ khó,
                hoặc nhờ mình gợi ý nội dung liên quan.
            </div>
        </div>
        <div id="chatInputArea">
            <textarea id="chatInput" placeholder="Nhập câu hỏi của bạn..."></textarea>
            <button id="chatSendBtn" type="button">
                Gửi <i class="fa-solid fa-paper-plane" style="margin-left:4px;"></i>
            </button>
        </div>
    </div>
</body>

<script>
    // Đóng / mở menu Mục lục bên trái khi bấm vào icon-dongmomenu
    document.addEventListener('DOMContentLoaded', function () {
        // Helper to update heading chip with animation
        window.updateHeadingChip = function (text) {
            const headingChip = document.querySelector('.article-heading-chip');
            if (!headingChip || headingChip.textContent === text) return;

            // Remove animation class if exists to restart it
            headingChip.classList.remove('heading-animate');
            // Trigger reflow
            void headingChip.offsetWidth;

            headingChip.textContent = text;
            headingChip.classList.add('heading-animate');
        };

        const toggleMenu = document.querySelector('.icon-dongmomenu');
        if (toggleMenu) {
            toggleMenu.addEventListener('click', function () {
                document.body.classList.toggle('toc-collapsed');
            });
        }

        // Audio đọc nội dung + nhạc nền
        const audioBtn = document.getElementById('audioBtn');
        const bgMusic = document.getElementById('bgMusic');
        const articleContent = document.querySelector('.article-content');
        const highlightModeBtn = document.getElementById('highlightModeBtn');
        const highlightList = document.getElementById('highlightList');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const chatToggleBtn = document.getElementById('chatToggleBtn');
        const chatPanel = document.getElementById('chatPanel');
        const chatCloseBtn = document.getElementById('chatCloseBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');

        // Sidebar tabs elements
        const tabItems = document.querySelectorAll('.sidebar-tabs .tab-item');
        const notesCard = document.getElementById('notesCard');
        const highlightsCard = document.getElementById('highlightsCard');
        const annotationsCard = document.getElementById('annotationsCard');
        const notesList = document.getElementById('notesList');
        const annotationsList = document.getElementById('annotationsList');
        const notesEmptyState = document.getElementById('notesEmptyState');
        const annotationsEmptyState = document.getElementById('annotationsEmptyState');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const addAnnotationBtn = document.getElementById('addAnnotationBtn');

        if (!articleContent) return;

        // Data storage
        let notes = [];
        let annotations = [];
        let highlightCounter = 0;

        // Load data from localStorage
        function loadStoredData() {
            try {
                const storedNotes = localStorage.getItem('reader-notes');
                const storedAnnotations = localStorage.getItem('reader-annotations');
                const storedHighlights = localStorage.getItem('reader-highlights');

                if (storedNotes) {
                    notes = JSON.parse(storedNotes);
                }
                if (storedAnnotations) {
                    annotations = JSON.parse(storedAnnotations);
                }
                if (storedHighlights) {
                    const parsed = JSON.parse(storedHighlights);
                    highlights.length = 0;
                    highlights.push(...parsed);
                    // Restore highlight marks in DOM if needed
                    highlights.forEach(hl => {
                        const el = document.getElementById(hl.anchorId);
                        if (el && !el.classList.contains('highlight-mark')) {
                            el.classList.add('highlight-mark');
                            if (hl.color) {
                                el.classList.add(`color-${hl.color}`);
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
        }

        // Save data to localStorage
        function saveStoredData() {
            try {
                localStorage.setItem('reader-notes', JSON.stringify(notes));
                localStorage.setItem('reader-annotations', JSON.stringify(annotations));
                localStorage.setItem('reader-highlights', JSON.stringify(highlights));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        // Tabs switching functionality
        function switchTab(tabName) {
            // Remove active class from all tabs
            tabItems.forEach(tab => tab.classList.remove('active'));

            // Hide all cards
            if (notesCard) notesCard.style.display = 'none';
            if (highlightsCard) highlightsCard.style.display = 'none';
            if (annotationsCard) annotationsCard.style.display = 'none';

            // Show selected tab and card
            const activeTab = Array.from(tabItems).find(tab => tab.dataset.tab === tabName);
            if (activeTab) {
                activeTab.classList.add('active');

                if (tabName === 'notes' && notesCard) {
                    notesCard.style.display = 'flex';
                    renderNotesList();
                } else if (tabName === 'highlights' && highlightsCard) {
                    highlightsCard.style.display = 'flex';
                    renderHighlightList();
                } else if (tabName === 'annotations' && annotationsCard) {
                    annotationsCard.style.display = 'flex';
                    renderAnnotationsList();
                }
            }

            // Save active tab to sessionStorage
            sessionStorage.setItem('activeSidebarTab', tabName);
        }

        // Initialize tabs
        if (tabItems.length > 0) {
            tabItems.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Restore active tab from sessionStorage
            const savedTab = sessionStorage.getItem('activeSidebarTab') || 'notes';
            switchTab(savedTab);
        }

        let isReading = false;
        let isPaused = false;
        let currentUtterance = null;

        function resetAudioState() {
            if (!audioBtn) return;
            isReading = false;
            isPaused = false;
            currentUtterance = null;
            audioBtn.classList.remove('active');
            audioBtn.querySelector('i').className = 'fa-solid fa-headphones';
            if (bgMusic) {
                bgMusic.pause();
                bgMusic.currentTime = 0;
            }
        }

        function startReading() {
            if (!audioBtn) return;
            const text = articleContent.innerText.trim();
            if (!text) return;

            if (!('speechSynthesis' in window)) {
                alert('Trình duyệt của bạn chưa hỗ trợ chức năng đọc văn bản (Speech Synthesis).');
                return;
            }

            // Hủy mọi đọc hiện tại trước khi bắt đầu mới
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            utterance.onend = resetAudioState;
            utterance.onerror = resetAudioState;

            currentUtterance = utterance;
            window.speechSynthesis.speak(utterance);

            isReading = true;
            isPaused = false;
            audioBtn.classList.add('active');
            audioBtn.querySelector('i').className = 'fa-solid fa-pause';

            if (bgMusic) {
                bgMusic.volume = 0.2;
                bgMusic.play().catch(() => { });
            }
        }

        function toggleAudio() {
            if (!audioBtn) return;
            const synth = window.speechSynthesis;

            // Nếu đang không đọc -> bắt đầu đọc
            if (!isReading) {
                startReading();
                return;
            }

            // Đang đọc và chưa tạm dừng -> tạm dừng
            if (!isPaused) {
                if (synth && synth.speaking) {
                    synth.pause();
                    isPaused = true;
                    audioBtn.querySelector('i').className = 'fa-solid fa-play';
                    if (bgMusic) {
                        bgMusic.pause();
                    }
                }
                return;
            }

            // Đang tạm dừng -> tiếp tục
            if (isPaused) {
                if (synth && synth.paused) {
                    synth.resume();
                    isPaused = false;
                    audioBtn.querySelector('i').className = 'fa-solid fa-pause';
                    if (bgMusic) {
                        bgMusic.play().catch(() => { });
                    }
                }
            }
        }

        // Nhấn nhanh: play/pause/resume; Nhấn kèm Alt: dừng hẳn
        if (audioBtn) {
            audioBtn.addEventListener('click', function (e) {
                if (e.altKey) {
                    window.speechSynthesis.cancel();
                    resetAudioState();
                } else {
                    toggleAudio();
                }
            });
        }

        // ======= CHẾ ĐỘ HIGHLIGHT + GHI CHÚ =======
        let isHighlightMode = false;
        const highlights = [];
        let activePopup = null;

        function closeHighlightPopup() {
            if (activePopup && activePopup.parentNode) {
                activePopup.parentNode.removeChild(activePopup);
            }
            activePopup = null;
        }

        function renderHighlightList() {
            if (!highlightList) return;
            if (!highlights.length) {
                highlightList.innerHTML = '<div class="empty-state"><i class="fa-regular fa-highlighter" style="font-size: 32px; color: #d6c7a8; margin-bottom: 8px;"></i><p style="font-size: 12px; color: #7a6651; text-align: center;">Chưa có đánh dấu nào.</p><p style="font-size: 11px; color: #9a8a7a; text-align: center; margin-top: 4px;">Bật chế độ highlight và chọn text để đánh dấu</p></div>';
                return;
            }

            highlightList.innerHTML = '';
            highlights.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'sidebar-highlight-item';
                div.dataset.anchorId = item.anchorId;
                div.dataset.index = index;

                // Color indicator
                const colorIndicator = document.createElement('div');
                colorIndicator.className = 'highlight-color-indicator';
                const color = item.color || 'yellow';
                const colorMap = {
                    yellow: '#ffdd71',
                    blue: '#a8d5ff',
                    pink: '#ffb3d9',
                    green: '#b3ffb3',
                    orange: '#ffcc99'
                };
                colorIndicator.style.backgroundColor = colorMap[color] || colorMap.yellow;
                div.appendChild(colorIndicator);

                const preview = document.createElement('div');
                preview.className = 'preview';
                preview.textContent = item.preview;
                div.appendChild(preview);

                if (item.note) {
                    const note = document.createElement('div');
                    note.className = 'note-text';
                    note.textContent = item.note;
                    div.appendChild(note);
                }

                // Footer with time and actions
                const footer = document.createElement('div');
                footer.className = 'highlight-actions';

                if (item.createdAt) {
                    const time = document.createElement('span');
                    time.className = 'highlight-time';
                    const date = new Date(item.createdAt);
                    time.textContent = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    footer.appendChild(time);
                }

                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '4px';

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.title = 'Xóa đánh dấu';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Bạn có chắc muốn xóa đánh dấu này?')) {
                        deleteHighlight(index);
                    }
                });
                actions.appendChild(deleteBtn);

                footer.appendChild(actions);
                div.appendChild(footer);

                // Click to scroll to highlight
                div.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return; // Don't scroll if clicking button
                    const el = document.getElementById(item.anchorId);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.classList.add('highlight-mark-active');
                        setTimeout(() => el.classList.remove('highlight-mark-active'), 1000);
                    }
                });

                highlightList.appendChild(div);
            });
        }

        // Delete highlight function
        function deleteHighlight(index) {
            if (index < 0 || index >= highlights.length) return;

            const item = highlights[index];

            // Remove highlight mark from DOM
            const el = document.getElementById(item.anchorId);
            if (el) {
                const parent = el.parentNode;
                if (parent) {
                    parent.replaceChild(document.createTextNode(el.textContent), el);
                    parent.normalize();
                }
            }

            // Remove from array
            highlights.splice(index, 1);

            // Re-render list
            renderHighlightList();

            // Save to localStorage
            saveStoredData();
        }

        // Render notes list
        function renderNotesList() {
            if (!notesList) return;

            if (!notes.length) {
                if (notesEmptyState) {
                    notesEmptyState.style.display = 'flex';
                }
                return;
            }

            if (notesEmptyState) {
                notesEmptyState.style.display = 'none';
            }

            notesList.innerHTML = '';
            notes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';

                const header = document.createElement('div');
                header.className = 'note-item-header';

                if (note.relatedText) {
                    const preview = document.createElement('div');
                    preview.className = 'note-item-preview';
                    preview.textContent = `"${note.relatedText.substring(0, 60)}${note.relatedText.length > 60 ? '...' : ''}"`;
                    header.appendChild(preview);
                }

                const content = document.createElement('div');
                content.className = 'note-item-content';
                content.textContent = note.content;
                noteItem.appendChild(header);
                noteItem.appendChild(content);

                // Click to scroll to related text if exists (only on content area, not buttons)
                if (note.relatedText) {
                    const scrollToText = (e) => {
                        // Don't scroll if clicking on buttons
                        if (e.target.closest('button')) return;

                        // Try to find the text in article content
                        const articleContent = document.querySelector('.article-content');
                        if (articleContent) {
                            const textNodes = getTextNodes(articleContent);
                            for (let node of textNodes) {
                                if (node.textContent.includes(note.relatedText.substring(0, 30))) {
                                    node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    // Brief highlight animation
                                    const originalBg = node.parentElement.style.backgroundColor;
                                    node.parentElement.style.backgroundColor = '#ffdd71';
                                    node.parentElement.style.transition = 'background-color 1s';
                                    setTimeout(() => {
                                        node.parentElement.style.backgroundColor = originalBg || '';
                                    }, 1000);
                                    break;
                                }
                            }
                        }
                    };

                    header.style.cursor = 'pointer';
                    content.style.cursor = 'pointer';
                    header.addEventListener('click', scrollToText);
                    content.addEventListener('click', scrollToText);
                }

                const footer = document.createElement('div');
                footer.className = 'note-item-footer';

                const time = document.createElement('span');
                time.className = 'note-item-time';
                if (note.updatedAt && note.updatedAt !== note.createdAt) {
                    const date = new Date(note.updatedAt);
                    time.textContent = `Đã cập nhật: ${date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                } else if (note.createdAt) {
                    const date = new Date(note.createdAt);
                    time.textContent = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                footer.appendChild(time);

                const actions = document.createElement('div');
                actions.className = 'note-item-actions';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                editBtn.title = 'Chỉnh sửa';
                editBtn.addEventListener('click', () => editNote(index));
                actions.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.title = 'Xóa';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Bạn có chắc muốn xóa ghi chú này?')) {
                        deleteNote(index);
                    }
                });
                actions.appendChild(deleteBtn);

                footer.appendChild(actions);
                noteItem.appendChild(footer);
                notesList.appendChild(noteItem);
            });
        }

        // Render annotations list
        function renderAnnotationsList() {
            if (!annotationsList) return;

            if (!annotations.length) {
                if (annotationsEmptyState) {
                    annotationsEmptyState.style.display = 'flex';
                }
                return;
            }

            if (annotationsEmptyState) {
                annotationsEmptyState.style.display = 'none';
            }

            annotationsList.innerHTML = '';
            annotations.forEach((annotation, index) => {
                const annItem = document.createElement('div');
                annItem.className = 'annotation-item';

                // Helper function to scroll to related text
                const scrollToRelatedText = (e) => {
                    if (e.target.closest('button')) return;
                    if (!annotation.relatedText) return;

                    const articleContent = document.querySelector('.article-content');
                    if (articleContent) {
                        const textNodes = getTextNodes(articleContent);
                        for (let node of textNodes) {
                            if (node.textContent.includes(annotation.relatedText.substring(0, 30))) {
                                node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                // Brief highlight animation
                                const originalBg = node.parentElement.style.backgroundColor;
                                node.parentElement.style.backgroundColor = '#a8d5ff';
                                node.parentElement.style.transition = 'background-color 1s';
                                setTimeout(() => {
                                    node.parentElement.style.backgroundColor = originalBg || '';
                                }, 1000);
                                break;
                            }
                        }
                    }
                };

                if (annotation.relatedText) {
                    const related = document.createElement('div');
                    related.className = 'annotation-item-related';
                    related.textContent = `"${annotation.relatedText.substring(0, 80)}${annotation.relatedText.length > 80 ? '...' : ''}"`;
                    related.style.cursor = 'pointer';
                    related.title = 'Click để scroll đến đoạn text được chú thích';
                    related.addEventListener('click', scrollToRelatedText);
                    annItem.appendChild(related);
                }

                const content = document.createElement('div');
                content.className = 'annotation-item-content';
                content.textContent = annotation.content;
                if (annotation.relatedText) {
                    content.style.cursor = 'pointer';
                    content.title = 'Click để scroll đến đoạn text được chú thích';
                    content.addEventListener('click', scrollToRelatedText);
                }
                annItem.appendChild(content);

                const footer = document.createElement('div');
                footer.className = 'annotation-item-footer';

                const time = document.createElement('span');
                time.className = 'annotation-item-time';
                if (annotation.updatedAt && annotation.updatedAt !== annotation.createdAt) {
                    const date = new Date(annotation.updatedAt);
                    time.textContent = `Đã cập nhật: ${date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                } else if (annotation.createdAt) {
                    const date = new Date(annotation.createdAt);
                    time.textContent = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                footer.appendChild(time);

                const actions = document.createElement('div');
                actions.className = 'annotation-item-actions';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                editBtn.title = 'Chỉnh sửa';
                editBtn.addEventListener('click', () => editAnnotation(index));
                actions.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.title = 'Xóa';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Bạn có chắc muốn xóa chú thích này?')) {
                        deleteAnnotation(index);
                    }
                });
                actions.appendChild(deleteBtn);

                footer.appendChild(actions);
                annItem.appendChild(footer);
                annotationsList.appendChild(annItem);
            });
        }

        // ======= QUẢN LÝ GHI CHÚ =======
        let activeNoteForm = null;

        // Show form to create/edit note
        function showNoteForm(noteIndex = null) {
            // Close any existing form
            closeNoteForm();

            const isEdit = noteIndex !== null;
            const note = isEdit ? notes[noteIndex] : null;

            const form = document.createElement('div');
            form.className = 'note-form-overlay';
            form.innerHTML = `
                <div class="note-form">
                    <div class="note-form-header">
                        <h3>${isEdit ? 'Chỉnh sửa ghi chú' : 'Thêm ghi chú mới'}</h3>
                        <button class="close-btn" title="Đóng">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="note-form-body">
                        <div class="form-group">
                            <label>Đoạn text liên quan (tùy chọn):</label>
                            <textarea id="noteRelatedText" rows="2" placeholder="Chọn đoạn text trong bài hoặc để trống...">${note ? (note.relatedText || '') : ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Nội dung ghi chú: <span style="color: #dc3545;">*</span></label>
                            <textarea id="noteContent" rows="6" placeholder="Nhập nội dung ghi chú..." required>${note ? note.content : ''}</textarea>
                        </div>
                    </div>
                    <div class="note-form-footer">
                        <button class="btn-cancel">Hủy</button>
                        <button class="btn-save">${isEdit ? 'Cập nhật' : 'Lưu'}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(form);
            activeNoteForm = { form, noteIndex };

            const relatedTextarea = form.querySelector('#noteRelatedText');
            const contentTextarea = form.querySelector('#noteContent');
            const closeBtn = form.querySelector('.close-btn');
            const cancelBtn = form.querySelector('.btn-cancel');
            const saveBtn = form.querySelector('.btn-save');

            // Focus on content textarea
            contentTextarea.focus();

            // Close handlers
            const closeHandler = () => closeNoteForm();
            closeBtn.addEventListener('click', closeHandler);
            cancelBtn.addEventListener('click', closeHandler);
            form.addEventListener('click', (e) => {
                if (e.target === form) closeHandler();
            });

            // Save handler
            saveBtn.addEventListener('click', () => {
                const content = contentTextarea.value.trim();
                const relatedText = relatedTextarea.value.trim();

                if (!content) {
                    alert('Vui lòng nhập nội dung ghi chú!');
                    contentTextarea.focus();
                    return;
                }

                if (isEdit) {
                    // Update existing note
                    notes[noteIndex].content = content;
                    notes[noteIndex].relatedText = relatedText || null;
                    notes[noteIndex].updatedAt = new Date().toISOString();
                } else {
                    // Create new note
                    const newNote = {
                        id: 'note-' + Date.now(),
                        content: content,
                        relatedText: relatedText || null,
                        chapter: getCurrentChapterTitle(),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    notes.push(newNote);
                }

                renderNotesList();
                saveStoredData();
                closeNoteForm();
            });

            // Keyboard shortcuts
            form.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeHandler();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveBtn.click();
                }
            });
        }

        function closeNoteForm() {
            if (activeNoteForm && activeNoteForm.form) {
                activeNoteForm.form.remove();
                activeNoteForm = null;
            }
        }

        function editNote(index) {
            if (index < 0 || index >= notes.length) return;
            showNoteForm(index);
        }

        function deleteNote(index) {
            if (index < 0 || index >= notes.length) return;
            notes.splice(index, 1);
            renderNotesList();
            saveStoredData();
        }

        // Get current chapter title
        function getCurrentChapterTitle() {
            const chapterTitle = document.querySelector('.article-heading-chip');
            return chapterTitle ? chapterTitle.textContent.trim() : 'Chưa xác định';
        }

        // Helper function to get all text nodes in an element
        function getTextNodes(element) {
            const textNodes = [];
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            let node;
            while (node = walker.nextNode()) {
                if (node.textContent.trim()) {
                    textNodes.push(node);
                }
            }
            return textNodes;
        }

        // Add note button handler
        if (addNoteBtn) {
            addNoteBtn.addEventListener('click', () => {
                showNoteForm();
            });
        }

        // ======= QUẢN LÝ CHÚ THÍCH =======
        let activeAnnotationForm = null;
        let annotationSelectionRange = null;

        // Show form to create/edit annotation
        function showAnnotationForm(annotationIndex = null, relatedText = null) {
            // Close any existing form
            closeAnnotationForm();

            const isEdit = annotationIndex !== null;
            const annotation = isEdit ? annotations[annotationIndex] : null;

            const form = document.createElement('div');
            form.className = 'note-form-overlay';
            form.innerHTML = `
                <div class="note-form">
                    <div class="note-form-header">
                        <h3>${isEdit ? 'Chỉnh sửa chú thích' : 'Thêm chú thích mới'}</h3>
                        <button class="close-btn" title="Đóng">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="note-form-body">
                        <div class="form-group">
                            <label>Đoạn text được chú thích: <span style="color: #dc3545;">*</span></label>
                            <div style="position: relative;">
                                <textarea id="annotationRelatedText" rows="3" placeholder="Chọn đoạn text trong bài hoặc nhập thủ công...">${annotation ? (annotation.relatedText || '') : (relatedText || '')}</textarea>
                                <button id="selectTextBtn" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 11px; border: 1px solid #d6c7a8; background: #fff; border-radius: 4px; cursor: pointer; color: #7a6651;">Chọn text</button>
                            </div>
                            <p style="font-size: 11px; color: #9a8a7a; margin-top: 4px;">Nhấn "Chọn text" để chọn đoạn text trong bài hoặc nhập thủ công</p>
                        </div>
                        <div class="form-group">
                            <label>Nội dung chú thích: <span style="color: #dc3545;">*</span></label>
                            <textarea id="annotationContent" rows="6" placeholder="Nhập nội dung chú thích..." required>${annotation ? annotation.content : ''}</textarea>
                        </div>
                    </div>
                    <div class="note-form-footer">
                        <button class="btn-cancel">Hủy</button>
                        <button class="btn-save">${isEdit ? 'Cập nhật' : 'Lưu'}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(form);
            activeAnnotationForm = { form, annotationIndex };

            const relatedTextarea = form.querySelector('#annotationRelatedText');
            const contentTextarea = form.querySelector('#annotationContent');
            const selectTextBtn = form.querySelector('#selectTextBtn');
            const closeBtn = form.querySelector('.close-btn');
            const cancelBtn = form.querySelector('.btn-cancel');
            const saveBtn = form.querySelector('.btn-save');

            // Select text button handler
            selectTextBtn.addEventListener('click', () => {
                form.style.display = 'none';
                const instruction = document.createElement('div');
                instruction.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4a3b2d; color: #fff; padding: 14px 20px; border-radius: 8px; z-index: 10001; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; max-width: 90%;';
                instruction.innerHTML = `
                    <i class="fa-solid fa-mouse-pointer" style="font-size: 16px;"></i>
                    <span>Vui lòng chọn đoạn text trong bài mà bạn muốn chú thích...</span>
                    <button id="cancelSelectBtn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">Hủy</button>
                `;
                document.body.appendChild(instruction);

                let isCancelled = false;
                const cancelBtn = instruction.querySelector('#cancelSelectBtn');

                const cleanup = () => {
                    if (instruction.parentNode) {
                        instruction.remove();
                    }
                    form.style.display = 'flex';
                    window.removeEventListener('mouseup', selectTextHandler);
                    if (timeoutId) clearTimeout(timeoutId);
                };

                const selectTextHandler = (e) => {
                    if (isCancelled) return;

                    const selection = window.getSelection();
                    if (selection && !selection.isCollapsed) {
                        const range = selection.getRangeAt(0);
                        if (articleContent && articleContent.contains(range.commonAncestorContainer)) {
                            const selectedText = selection.toString().trim();
                            if (selectedText) {
                                relatedTextarea.value = selectedText;
                                annotationSelectionRange = range.cloneRange();
                                cleanup();
                                return;
                            }
                        }
                    }
                };

                cancelBtn.addEventListener('click', () => {
                    isCancelled = true;
                    cleanup();
                });

                window.addEventListener('mouseup', selectTextHandler);

                // Cancel selection mode after 15 seconds
                const timeoutId = setTimeout(() => {
                    cleanup();
                }, 15000);
            });

            // Focus on content textarea
            contentTextarea.focus();

            // Close handlers
            const closeHandler = () => closeAnnotationForm();
            closeBtn.addEventListener('click', closeHandler);
            cancelBtn.addEventListener('click', closeHandler);
            form.addEventListener('click', (e) => {
                if (e.target === form) closeHandler();
            });

            // Save handler
            saveBtn.addEventListener('click', () => {
                const content = contentTextarea.value.trim();
                const relatedTextValue = relatedTextarea.value.trim();

                if (!content) {
                    alert('Vui lòng nhập nội dung chú thích!');
                    contentTextarea.focus();
                    return;
                }

                if (!relatedTextValue) {
                    alert('Vui lòng chọn hoặc nhập đoạn text được chú thích!');
                    relatedTextarea.focus();
                    return;
                }

                if (isEdit) {
                    // Update existing annotation
                    annotations[annotationIndex].content = content;
                    annotations[annotationIndex].relatedText = relatedTextValue;
                    annotations[annotationIndex].updatedAt = new Date().toISOString();
                } else {
                    // Create new annotation
                    const newAnnotation = {
                        id: 'ann-' + Date.now(),
                        content: content,
                        relatedText: relatedTextValue,
                        chapter: getCurrentChapterTitle(),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    annotations.push(newAnnotation);
                }

                renderAnnotationsList();
                saveStoredData();
                closeAnnotationForm();
            });

            // Keyboard shortcuts
            form.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeHandler();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveBtn.click();
                }
            });
        }

        function closeAnnotationForm() {
            if (activeAnnotationForm && activeAnnotationForm.form) {
                activeAnnotationForm.form.remove();
                activeAnnotationForm = null;
                annotationSelectionRange = null;
            }
        }

        function editAnnotation(index) {
            if (index < 0 || index >= annotations.length) return;
            showAnnotationForm(index);
        }

        function deleteAnnotation(index) {
            if (index < 0 || index >= annotations.length) return;
            if (confirm('Bạn có chắc muốn xóa chú thích này?')) {
                annotations.splice(index, 1);
                renderAnnotationsList();
                saveStoredData();
            }
        }

        // Add annotation button handler
        if (addAnnotationBtn) {
            addAnnotationBtn.addEventListener('click', () => {
                showAnnotationForm();
            });
        }

        // Add context menu option to create annotation from text selection
        function addAnnotationFromSelection() {
            const selection = window.getSelection();
            if (!selection || selection.isCollapsed) {
                alert('Vui lòng chọn đoạn text trong bài trước!');
                return;
            }

            const range = selection.getRangeAt(0);
            if (!articleContent || !articleContent.contains(range.commonAncestorContainer)) {
                alert('Vui lòng chọn text trong nội dung bài đọc!');
                return;
            }

            const selectedText = selection.toString().trim();
            if (!selectedText) {
                alert('Vui lòng chọn đoạn text!');
                return;
            }

            showAnnotationForm(null, selectedText);
            selection.removeAllRanges();
        }

        // Tạo popup chọn loại highlight
        function showHighlightPopup(x, y, range) {
            closeHighlightPopup();

            const popup = document.createElement('div');
            popup.className = 'highlight-popup';
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';

            popup.innerHTML = ''
                + '<h4>Đánh dấu đoạn đã chọn</h4>'
                + '<div class="option-row">'
                + '  <input type="radio" name="hlType" value="highlight" id="hlOnly" checked>'
                + '  <label for="hlOnly">Chỉ highlight</label>'
                + '</div>'
                + '<div class="option-row">'
                + '  <input type="radio" name="hlType" value="note" id="hlNote">'
                + '  <label for="hlNote">Highlight + Ghi chú</label>'
                + '</div>'
                + '<div style="margin: 12px 0;"><label style="font-size: 12px; color: #4a3b2d; margin-bottom: 6px; display: block;">Chọn màu:</label>'
                + '  <div style="display: flex; gap: 8px;">'
                + '    <button type="button" class="color-btn" data-color="yellow" style="width: 30px; height: 30px; border-radius: 4px; border: 2px solid #d6c7a8; background: #ffdd71; cursor: pointer;" title="Vàng"></button>'
                + '    <button type="button" class="color-btn" data-color="blue" style="width: 30px; height: 30px; border-radius: 4px; border: 2px solid #d6c7a8; background: #a8d5ff; cursor: pointer;" title="Xanh"></button>'
                + '    <button type="button" class="color-btn" data-color="pink" style="width: 30px; height: 30px; border-radius: 4px; border: 2px solid #d6c7a8; background: #ffb3d9; cursor: pointer;" title="Hồng"></button>'
                + '    <button type="button" class="color-btn" data-color="green" style="width: 30px; height: 30px; border-radius: 4px; border: 2px solid #d6c7a8; background: #b3ffb3; cursor: pointer;" title="Xanh lá"></button>'
                + '    <button type="button" class="color-btn" data-color="orange" style="width: 30px; height: 30px; border-radius: 4px; border: 2px solid #d6c7a8; background: #ffcc99; cursor: pointer;" title="Cam"></button>'
                + '  </div>'
                + '</div>'
                + '<textarea id="hlNoteText" placeholder="Nội dung ghi chú (tùy chọn)..."></textarea>'
                + '<div class="btn-row">'
                + '  <button type="button" class="">Hủy</button>'
                + '  <button type="button" class="primary">Lưu</button>'
                + '</div>';

            document.body.appendChild(popup);
            activePopup = popup;

            const buttons = popup.querySelectorAll('.btn-row button');
            const cancelBtn = buttons[0];
            const saveBtn = buttons[1];
            const noteTextarea = popup.querySelector('#hlNoteText');
            const colorBtns = popup.querySelectorAll('.color-btn');

            // Default selected color
            let selectedColor = 'yellow';
            colorBtns.forEach(btn => {
                if (btn.dataset.color === selectedColor) {
                    btn.style.border = '2px solid #4a3b2d';
                }
                btn.addEventListener('click', function () {
                    selectedColor = this.dataset.color;
                    colorBtns.forEach(b => b.style.border = '2px solid #d6c7a8');
                    this.style.border = '2px solid #4a3b2d';
                });
            });

            cancelBtn.addEventListener('click', () => {
                closeHighlightPopup();
                window.getSelection().removeAllRanges();
            });

            saveBtn.addEventListener('click', () => {
                const type = popup.querySelector('input[name="hlType"]:checked').value;
                const noteText = noteTextarea.value.trim();

                if (type === 'note' && !noteText) {
                    // Nếu chọn ghi chú nhưng không nhập nội dung → nhắc nhẹ
                    noteTextarea.focus();
                    return;
                }

                const span = document.createElement('span');
                const anchorId = 'hl-' + (++highlightCounter);
                span.id = anchorId;
                span.className = 'highlight-mark color-' + selectedColor;

                try {
                    range.surroundContents(span);
                } catch (e) {
                    // Nếu surround thất bại (range phức tạp) thì bỏ qua
                    closeHighlightPopup();
                    window.getSelection().removeAllRanges();
                    return;
                }

                const fullText = span.textContent || '';
                const preview = fullText.length > 80 ? fullText.slice(0, 80) + '…' : fullText;

                highlights.push({
                    id: anchorId,
                    anchorId,
                    preview,
                    note: type === 'note' ? noteText : '',
                    color: selectedColor,
                    createdAt: new Date().toISOString()
                });

                // Nếu chọn "Highlight + Ghi chú", tự động tạo note trong danh sách notes
                if (type === 'note' && noteText) {
                    const newNote = {
                        id: 'note-' + Date.now(),
                        content: noteText,
                        relatedText: fullText,
                        chapter: getCurrentChapterTitle(),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    notes.push(newNote);
                    renderNotesList();
                }

                renderHighlightList();
                saveStoredData();
                closeHighlightPopup();
                window.getSelection().removeAllRanges();
            });
        }

        // Load stored data on page load
        loadStoredData();

        if (highlightList) {
            renderHighlightList();
        }

        // Initial render for notes and annotations
        renderNotesList();
        renderAnnotationsList();

        // Bật / tắt chế độ highlight khi bấm icon
        if (highlightModeBtn) {
            highlightModeBtn.addEventListener('click', function () {
                isHighlightMode = !isHighlightMode;
                highlightModeBtn.classList.toggle('active', isHighlightMode);
                if (!isHighlightMode) {
                    closeHighlightPopup();
                }
            });
        }

        // Lắng nghe việc chọn text trong nội dung khi đang ở chế độ highlight
        articleContent.addEventListener('mouseup', function (event) {
            if (!isHighlightMode) return;

            const selection = window.getSelection();
            if (!selection || selection.isCollapsed) return;

            const range = selection.getRangeAt(0);
            if (!articleContent.contains(range.commonAncestorContainer)) return;

            const x = event.pageX + 10;
            const y = event.pageY + 10;
            showHighlightPopup(x, y, range.cloneRange());
        });

        articleContent.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        // Chặn kéo thả nội dung trong vùng bài viết
        articleContent.addEventListener('dragstart', function (e) {
            e.preventDefault();
        });

        // Chặn sự kiện copy (Ctrl+C, menu Edit → Copy, ...)
        document.addEventListener('copy', function (e) {
            // Chỉ chặn nếu focus đang trong nội dung bài hoặc không ở ô input/textarea
            const active = document.activeElement;
            const isFormField = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
            if (!isFormField) {
                e.preventDefault();
            }
        });

        // Chặn một số tổ hợp phím hay dùng để copy / xem source
        document.addEventListener('keydown', function (e) {
            const key = e.key.toLowerCase();
            const ctrlOrMeta = e.ctrlKey || e.metaKey;

            // Không chặn khi đang gõ ở ô nhập (search, chat, ghi chú, chú thích)
            const active = document.activeElement;
            const isFormField = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
            if (isFormField) return;

            if (ctrlOrMeta) {
                // Các phím cần chặn: copy, cut, paste, select all, save, print, view source
                if (['c', 'x', 'v', 'a', 's', 'p', 'u'].includes(key)) {
                    e.preventDefault();
                }
            }

            // Chặn mở DevTools cơ bản (F12, Ctrl+Shift+I)
            if (key === 'f12' || (ctrlOrMeta && e.shiftKey && key === 'i')) {
                e.preventDefault();
            }
        });

        // ======= CHẾ ĐỘ SÁNG / TỐI =======
        function applyTheme(theme) {
            const isDark = theme === 'dark';
            document.body.classList.toggle('dark-theme', isDark);
            if (themeToggleBtn) {
                themeToggleBtn.classList.toggle('active', isDark);
                const icon = isDark ? 'fa-sun' : 'fa-moon';
                const title = isDark ? 'Chế độ sáng' : 'Chế độ tối';
                themeToggleBtn.innerHTML = '<i class="fa-solid ' + icon + '"></i>';
                themeToggleBtn.title = title;
            }
        }

        // Khởi tạo theme từ localStorage
        let savedTheme = null;
        try {
            savedTheme = localStorage.getItem('reader-theme');
        } catch (e) { }

        if (savedTheme === 'dark' || savedTheme === 'light') {
            applyTheme(savedTheme);
        } else {
            applyTheme('light');
        }

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', function () {
                const isDarkNow = document.body.classList.contains('dark-theme');
                const nextTheme = isDarkNow ? 'light' : 'dark';
                applyTheme(nextTheme);
                try {
                    localStorage.setItem('reader-theme', nextTheme);
                } catch (e) { }
            });
        }

        // ======= CHATBOT UI + KẾT NỐI API (placeholder) =======
        function appendChatMessage(text, role) {
            if (!chatMessages) return;
            const div = document.createElement('div');
            div.className = 'chat-message ' + (role === 'user' ? 'user' : 'bot');
            div.textContent = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function setChatTyping(isTyping) {
            if (!chatMessages) return;
            let typingEl = document.getElementById('chat-typing');
            if (isTyping) {
                if (!typingEl) {
                    typingEl = document.createElement('div');
                    typingEl.id = 'chat-typing';
                    typingEl.className = 'chat-message bot';
                    typingEl.textContent = 'Đang trả lời...';
                    chatMessages.appendChild(typingEl);
                }
            } else if (typingEl && typingEl.parentNode) {
                typingEl.parentNode.removeChild(typingEl);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendToChatGPT(messages, contextText) {
            // !!! LƯU Ý:
            // - Cách làm này chỉ nên dùng khi bạn chạy local / demo cá nhân.
            // - Không nên public vì API key sẽ lộ trong file JS.
            const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY_HERE'; // <-- Bạn tự điền key của mình vào đây

            // Ghép ngữ cảnh chương sách vào system message cho đơn giản
            const finalMessages = [
                {
                    role: 'system',
                    content: 'Bạn là trợ lý giúp giải thích nội dung sách, trả lời ngắn gọn, dễ hiểu bằng tiếng Việt.'
                },
                {
                    role: 'system',
                    content: 'Đây là ngữ cảnh từ chương sách (đã rút gọn):\n' + (contextText || '').slice(0, 2000)
                },
                // Giữ lại các message của user
                ...messages.filter(m => m.role === 'user')
            ];

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + OPENAI_API_KEY
                },
                body: JSON.stringify({
                    model: 'gpt-4.1-mini', // hoặc đổi sang model bạn có quyền dùng
                    messages: finalMessages,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error('Lỗi API: ' + response.status);
            }

            const data = await response.json();
            return (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content)
                ? data.choices[0].message.content
                : 'Không nhận được câu trả lời từ AI.';
        }

        async function handleSendChat() {
            if (!chatInput || !chatInput.value.trim()) return;
            const userText = chatInput.value.trim();
            chatInput.value = '';

            appendChatMessage(userText, 'user');

            // Chuẩn bị ngữ cảnh từ trang sách
            const contextText = (articleContent ? articleContent.innerText : '').slice(0, 2000);
            const chapterTitleEl = document.querySelector('.article-heading-chip');
            const chapterTitle = chapterTitleEl ? chapterTitleEl.textContent : '';

            const messages = [
                {
                    role: 'system',
                    content: 'Bạn là trợ lý giúp giải thích nội dung sách, trả lời ngắn gọn, dễ hiểu bằng tiếng Việt.'
                },
                {
                    role: 'user',
                    content: `Tiêu đề chương: ${chapterTitle}\nĐoạn trích (có thể rút gọn):\n${contextText}\n\nCâu hỏi của tôi: ${userText}`
                }
            ];

            setChatTyping(true);
            try {
                const answer = await sendToChatGPT(messages, contextText);
                setChatTyping(false);
                appendChatMessage(answer, 'bot');
            } catch (err) {
                setChatTyping(false);
                appendChatMessage('Có lỗi khi gọi chatbot. Vui lòng thử lại sau.', 'bot');
            }
        }

        if (chatToggleBtn && chatPanel) {
            chatToggleBtn.addEventListener('click', function () {
                const isVisible = chatPanel.style.display === 'flex';
                chatPanel.style.display = isVisible ? 'none' : 'flex';
            });
        }

        if (chatCloseBtn && chatPanel) {
            chatCloseBtn.addEventListener('click', function () {
                chatPanel.style.display = 'none';
            });
        }

        if (chatSendBtn) {
            chatSendBtn.addEventListener('click', handleSendChat);
        }

        if (chatInput) {
            chatInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendChat();
                }
            });
        }

        // =====================
        // FULLSCREEN TOGGLE
        // =====================
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        // Helper: vào fullscreen (hỗ trợ đa trình duyệt)
        function enterFullscreen(el) {
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            else if (el.msRequestFullscreen) el.msRequestFullscreen();
        }

        // Helper: thoát fullscreen
        function exitFullscreen() {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            else if (document.msExitFullscreen) document.msExitFullscreen();
        }

        // Helper: lấy trạng thái fullscreen hiện tại
        function getFullscreenElement() {
            return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
        }

        // Cập nhật icon và layout khi trạng thái fullscreen thay đổi
        function updateFullscreenIcon() {
            if (!fullscreenBtn) return;
            const icon = fullscreenBtn.querySelector('i');
            if (getFullscreenElement()) {
                // Vào fullscreen
                document.body.classList.add('fullscreen-mode');
                icon.className = 'fa-solid fa-compress';
                fullscreenBtn.classList.add('active');
                fullscreenBtn.title = 'Thoát toàn màn hình';
            } else {
                // Thoát fullscreen
                document.body.classList.remove('fullscreen-mode');
                icon.className = 'fa-solid fa-expand';
                fullscreenBtn.classList.remove('active');
                fullscreenBtn.title = 'Toàn màn hình';
            }
        }

        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', function () {
                if (!getFullscreenElement()) {
                    enterFullscreen(document.documentElement);
                } else {
                    exitFullscreen();
                }
            });
        }

        // Lắng nghe sự kiện fullscreenchange (bao gồm khi user nhấn Esc)
        document.addEventListener('fullscreenchange', updateFullscreenIcon);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
        document.addEventListener('msfullscreenchange', updateFullscreenIcon);

        // =====================
        // SEARCH CHAPTERS
        // =====================
        const searchInput = document.getElementById('searchInput');
        const searchDropdown = document.getElementById('searchDropdown');

        // Danh sách chương đầy đủ - TỰ ĐỘNG RENDER MỤC LỤC
        const chapters = [
            { id: 'intro-cover', title: 'Ảnh bìa', section: 'GIỚI THIỆU', file: 'Text_bia.html' },
            { id: 'intro-publisher', title: 'Nhà xuất bản', section: 'GIỚI THIỆU', file: 'Text_nha_xuat_ban.html' },
            { id: 'intro-work', title: 'Lời giới thiệu sách', section: 'GIỚI THIỆU', file: 'Text_tac_pham.html' },
            { id: 'intro-publisher-intro', title: 'Giới thiệu NXB', section: 'GIỚI THIỆU', file: 'Text_gioi_thieu_NXB.html' },
            { id: 'intro-author', title: 'Lời giới thiệu tác giả', section: 'GIỚI THIỆU', file: 'Text_tac_gia.html' },
            { id: 'ch1', title: 'Bản đồ cổ', section: 'PHẦN 1', file: 'Chương/Chương 1. Bản đồ cổ.html' },
            { id: 'ch2', title: 'Cảnh quan Hà Nội thời Pháp', section: 'PHẦN 1', file: 'Chương/Chương 2. Cảnh quan Hà Nội thời Pháp.html' },
            { id: 'ch3', title: 'Hồ Gươm và những câu chuyện xung quanh', section: 'PHẦN 1', file: 'Chương/Chương 3. Hồ Gươm và những câu chuyện xung quanh.html' },
            { id: 'ch4', title: 'Văn hóa và phong cách sống Hà Nội', section: 'PHẦN 2', file: 'Chương/Chương 4. Văn hóa và phong cách sống Hà Nội.html' },
            { id: 'ch5', title: 'Đời sống vật chất và thú chơi', section: 'PHẦN 2', file: 'Chương/Chương 5. Đời sống vật chất và thú chơi.html' },
            { id: 'ch6', title: 'Chuyện làng, chuyện phố', section: 'PHẦN 2', file: 'Chương/Chương 6. Chuyện làng, chuyện phố.html' },
        ];

        // Hàm lấy các phần (h2) từ file chương
        async function getChapterSections(chapterFile) {
            if (!chapterFile || !chapterFile.includes('Chương/')) {
                return [];
            }
            try {
                const response = await fetch(chapterFile);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const h2Elements = doc.querySelectorAll('h2');
                const sections = [];
                h2Elements.forEach(h2 => {
                    const text = h2.textContent.trim();
                    // Bỏ qua phần "CÂU HỎI TỔNG KẾT"
                    if (!text.includes('CÂU HỎI') && !text.includes('Câu hỏi')) {
                        sections.push({
                            title: text,
                            id: h2.id || text.toLowerCase().replace(/\s+/g, '-')
                        });
                    }
                });
                return sections;
            } catch (error) {
                console.error('Error loading chapter sections:', error);
                return [];
            }
        }
        // Helper để chuyển đổi số sang số La Mã
        function getRomanNumeral(n) {
            const roman = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII", "XIII", "XIV", "XV"];
            return roman[n] || n;
        }

        // Hàm render mục lục tự động từ mảng chapters với 2 cấp
        async function renderTOC() {
            const tocContent = document.getElementById('tocContent');
            if (!tocContent) return;

            // Không hiển thị PHẦN 1 / PHẦN 2 nữa, chỉ hiển thị danh sách chương + các phần nhỏ bên trong
            // Render theo đúng thứ tự trong mảng chapters
            let html = '<ul class="toc-list">';
            let currentSection = '';

            for (let index = 0; index < chapters.length; index++) {
                const chapter = chapters[index];

                let displayTitle = chapter.title;
                if (chapter.id.startsWith('ch')) {
                    const chapterNum = chapter.id.replace('ch', '');
                    displayTitle = `Chương ${chapterNum}`;
                }

                // Lấy các phần con (mục 1., 2., ...) từ file chương
                const subSections = await getChapterSections(chapter.file);

                html += `<li class="toc-chapter" data-chapter="${chapter.id}" data-index="${index}">
                    <div class="toc-chapter-title">
                        <span>${displayTitle}</span>
                        ${subSections.length > 0 ? '<i class="fa-solid fa-chevron-right chevron"></i>' : ''}
                    </div>`;

                // Nếu có phần con, thêm sub-list
                if (subSections.length > 0) {
                    html += '<ul class="toc-sub-list">';
                    subSections.forEach((subSection, subIndex) => {
                        html += `<li class="toc-section" data-chapter="${chapter.id}" data-index="${index}" data-section="${subIndex}">${subSection.title}</li>`;
                    });
                    html += '</ul>';
                }

                html += '</li>';
            }

            html += '</ul>';

            tocContent.innerHTML = html;

            // Thêm event listener cho các item trong mục lục (cấp 1 - chương)
            tocContent.querySelectorAll('.toc-chapter').forEach(li => {
                const chapterTitle = li.querySelector('.toc-chapter-title');
                if (chapterTitle) {
                    chapterTitle.addEventListener('click', function (e) {
                        e.stopPropagation();

                        // Toggle mở rộng menu con
                        li.classList.toggle('expanded');

                        const chapterIndex = parseInt(li.dataset.index);
                        if (!isNaN(chapterIndex)) {
                            loadChapter(chapterIndex);
                        }
                    });
                }
            });

            // Thêm event listener cho các phần con (cấp 2)
            tocContent.querySelectorAll('.toc-section').forEach(li => {
                li.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const chapterIndex = parseInt(this.dataset.index);
                    const sectionIndex = parseInt(this.dataset.section);
                    if (!isNaN(chapterIndex)) {
                        loadChapter(chapterIndex, sectionIndex);
                    }
                });
            });
        }

        // Helper: bỏ dấu tiếng Việt
        function removeAccents(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
        }

        // Helper: highlight từ khóa trong text
        function highlightKeyword(text, keyword) {
            if (!keyword) return text;
            const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Render kết quả tìm kiếm
        function renderSearchResults(results, keyword) {
            if (results.length === 0) {
                searchDropdown.innerHTML = '<div class="search-no-result">Không tìm thấy chương nào</div>';
                return;
            }

            let html = '';
            let currentSection = '';
            results.forEach(ch => {
                if (ch.section !== currentSection) {
                    currentSection = ch.section;
                    html += `<div class="search-result-section">${currentSection}</div>`;
                }
                const highlightedTitle = highlightKeyword(ch.title, keyword);
                html += `<div class="search-result-item" data-id="${ch.id}"><i class="fa-solid fa-book-open"></i><span>${highlightedTitle}</span></div>`;
            });
            searchDropdown.innerHTML = html;
        }

        // Scroll đến chương trong mục lục và highlight
        function scrollToChapter(chapterId) {
            // Tìm chapter trong danh sách
            const chapter = chapters.find(c => c.id === chapterId);
            if (!chapter) return;

            // Tìm tất cả li trong toc-list
            const tocItems = document.querySelectorAll('.toc-list li');
            tocItems.forEach(item => {
                item.classList.remove('search-active');
                // So sánh text
                if (item.textContent.trim() === chapter.title ||
                    removeAccents(item.textContent.trim().toLowerCase()).includes(removeAccents(chapter.title.toLowerCase()).substring(0, 10))) {
                    item.classList.add('search-active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Xóa highlight sau 3 giây
                    setTimeout(() => {
                        item.classList.remove('search-active');
                    }, 3000);
                }
            });
        }

        if (searchInput && searchDropdown) {
            // Input event - filter realtime
            searchInput.addEventListener('input', function () {
                const keyword = this.value.trim();
                if (!keyword) {
                    searchDropdown.classList.remove('show');
                    return;
                }

                const keywordLower = removeAccents(keyword.toLowerCase());
                const results = chapters.filter(ch =>
                    removeAccents(ch.title.toLowerCase()).includes(keywordLower)
                );

                renderSearchResults(results, keyword);
                searchDropdown.classList.add('show');
            });

            // Click vào kết quả
            searchDropdown.addEventListener('click', function (e) {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const chapterId = item.dataset.id;
                    scrollToChapter(chapterId);
                    searchDropdown.classList.remove('show');
                    searchInput.value = '';
                }
            });

            // Enter để chọn kết quả đầu tiên
            searchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    const firstItem = searchDropdown.querySelector('.search-result-item');
                    if (firstItem) {
                        const chapterId = firstItem.dataset.id;
                        scrollToChapter(chapterId);
                        searchDropdown.classList.remove('show');
                        searchInput.value = '';
                    }
                }
                if (e.key === 'Escape') {
                    searchDropdown.classList.remove('show');
                }
            });

            // Click ngoài để đóng dropdown
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.search-box')) {
                    searchDropdown.classList.remove('show');
                }
            });
        }

        // =====================
        // CHAPTER NAVIGATION
        // =====================
        const prevChapterBtn = document.getElementById('prevChapterBtn');
        const nextChapterBtn = document.getElementById('nextChapterBtn');
        let currentChapterIndex = 0; // Mặc định đang ở chương đầu tiên

        // Cập nhật trạng thái nút prev/next
        function updateChapterNavButtons() {
            if (prevChapterBtn) {
                prevChapterBtn.disabled = currentChapterIndex <= 0;
            }
            if (nextChapterBtn) {
                nextChapterBtn.disabled = currentChapterIndex >= chapters.length - 1;
            }
        }

        // Highlight chương trong mục lục
        let lastHighlightedIndex = -1;
        function highlightTocItem(index, sectionIndex = null) {
            // Xóa highlight cũ
            document.querySelectorAll('.toc-chapter, .toc-section').forEach(li => {
                li.classList.remove('toc-active');
            });

            // Tìm chương trong mục lục theo data-index
            const chapterLi = document.querySelector(`.toc-chapter[data-index="${index}"]`);
            if (chapterLi) {
                chapterLi.classList.add('toc-active');

                // Tự động mở rộng chương nếu chuyển sang chương mới HOẶC có chọn mục con
                // Nếu là nhấn lại vào chính chương đó (index === lastHighlightedIndex) thì để người dùng tự toggle (expand/collapse)
                if (index !== lastHighlightedIndex || sectionIndex !== null) {
                    chapterLi.classList.add('expanded');
                }
                lastHighlightedIndex = index;

                // Nếu có sectionIndex, highlight phần con tương ứng
                if (sectionIndex !== null) {
                    const subSections = chapterLi.querySelectorAll('.toc-section');
                    if (subSections[sectionIndex]) {
                        subSections[sectionIndex].classList.add('toc-active');
                    }
                }
            }
        }

        // Load chương theo index, có thể scroll đến phần cụ thể
        async function loadChapter(index, sectionIndex = null) {
            if (index < 0 || index >= chapters.length) return;

            currentChapterIndex = index;
            const chapter = chapters[index];

            // Cập nhật tiêu đề chương: Chỉ cập nhật nếu không có mục con (để tránh nháy 2 lần)
            if (sectionIndex === null) {
                updateHeadingChip(chapter.title || '');
            }

            // Load nội dung từ file
            const articleContent = document.querySelector('.article-content');
            const articleWrapper = document.querySelector('.article-wrapper');

            if (articleContent && chapter.file) {
                try {
                    // Nếu là chương (ch1, ch2...) và không có mục con cụ thể, hiển thị trang title sang trọng
                    if (chapter.id.startsWith('ch') && sectionIndex === null) {
                        const chapterNum = parseInt(chapter.id.replace('ch', ''));
                        const romanNum = getRomanNumeral(chapterNum);
                        const cleanTitle = (chapter.title || '').replace(/^Chương \d+\.?\s*/i, '');

                        articleContent.innerHTML = `
                            <div class="chapter-intro-container">
                                <div class="chapter-intro-num">CHƯƠNG ${romanNum}</div>
                                <div class="chapter-intro-title">${cleanTitle}</div>
                            </div>
                        `;
                    } else {
                        // Hiển thị loading
                        articleContent.innerHTML = '<p style="text-align:center; padding:40px;">Đang tải chương...</p>';

                        const response = await fetch(chapter.file);
                        if (!response.ok) throw new Error('Không thể tải chương');

                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        // Lấy nội dung từ body của file chương
                        const chapterBody = doc.body;

                        // Tìm nội dung chính: ưu tiên .article-content, sau đó là body trực tiếp
                        let chapterContent = chapterBody.querySelector('.article-content');
                        if (!chapterContent) {
                            // Nếu không có .article-content, lấy tất cả nội dung trong body trừ script, style, và scroll button
                            const tempDiv = document.createElement('div');
                            Array.from(chapterBody.children).forEach(child => {
                                if (child.tagName !== 'SCRIPT' &&
                                    child.tagName !== 'STYLE' &&
                                    child.tagName !== 'A' &&
                                    !child.classList.contains('scrollTopBtn')) {
                                    tempDiv.appendChild(child.cloneNode(true));
                                }
                            });
                            chapterContent = tempDiv;
                        }

                        // Copy nội dung vào article-content
                        if (chapterContent && chapterContent.innerHTML) {
                            articleContent.innerHTML = chapterContent.innerHTML;
                        } else {
                            // Fallback: lấy toàn bộ body nhưng loại bỏ script và style
                            const cleanHtml = chapterBody.innerHTML
                                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                                .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
                                .replace(/<a[^>]*class="scrollTopBtn"[^>]*>.*?<\/a>/gi, '');
                            articleContent.innerHTML = cleanHtml;
                        }

                        // Xử lý các link CSS trong file chương (nếu có)
                        const chapterStyles = doc.querySelectorAll('link[rel="stylesheet"]');
                        chapterStyles.forEach(link => {
                            const href = link.getAttribute('href');
                            if (href) {
                                // Xử lý relative path
                                let resolvedHref = href;
                                if (href.startsWith('../')) {
                                    resolvedHref = href.replace('../', '');
                                }
                                if (!document.querySelector(`link[href="${resolvedHref}"]`)) {
                                    const newLink = document.createElement('link');
                                    newLink.rel = 'stylesheet';
                                    newLink.href = resolvedHref;
                                    document.head.appendChild(newLink);
                                }
                            }
                        });

                        // Xử lý các script trong file chương (nếu cần)
                        const chapterScripts = doc.querySelectorAll('script');
                        chapterScripts.forEach(script => {
                            if (script.src) {
                                // Chỉ load script từ file chương nếu cần
                                const src = script.src.startsWith('../') ? script.src.replace('../', '') : script.src;
                                if (!document.querySelector(`script[src="${src}"]`)) {
                                    const newScript = document.createElement('script');
                                    newScript.src = src;
                                    document.body.appendChild(newScript);
                                }
                            }
                        });

                        // Scroll đến phần cụ thể nếu có sectionIndex
                        if (sectionIndex !== null && articleContent) {
                            setTimeout(() => {
                                // Lọc h2 tương tự như lúc render TOC để khớp index
                                const allH2 = Array.from(articleContent.querySelectorAll('h2'));
                                const filteredH2 = allH2.filter(h2 => {
                                    const text = h2.textContent.trim();
                                    return !text.includes('CÂU HỎI') && !text.includes('Câu hỏi');
                                });

                                const targetH2 = filteredH2[sectionIndex];
                                if (targetH2) {
                                    targetH2.scrollIntoView({
                                        behavior: 'smooth',
                                        block: 'start'
                                    });
                                    // Highlight phần được chọn
                                    targetH2.style.backgroundColor = '#ffdd71';
                                    setTimeout(() => {
                                        targetH2.style.backgroundColor = '';
                                    }, 2000);

                                    // Cập nhật tiêu đề chip sang tiêu đề phần con
                                    updateHeadingChip(targetH2.textContent.trim());
                                }
                            }, 100);
                        }

                    }
                } catch (error) {
                    console.error('Lỗi khi tải chương:', error);
                    articleContent.innerHTML = `<p style="text-align:center; padding:40px; color:#b02022;">Không thể tải chương: ${chapter.title}<br><small>${error.message}</small></p>`;
                }
            }

            // Highlight chương trong mục lục
            highlightTocItem(currentChapterIndex, sectionIndex);

            // Scroll lên đầu nội dung nếu không có sectionIndex
            if (sectionIndex === null && articleWrapper) {
                articleWrapper.scrollTop = 0;
            }

            // Cập nhật trạng thái nút và tiến độ
            updateChapterNavButtons();
            updateProgressNavButtons();
            updateReadingProgress();

            // Lưu tiến độ
            saveReadingProgress();

            // Thông báo nhẹ (optional)
            console.log(`Đã chuyển đến: ${chapter.title}${sectionIndex !== null ? ` - Phần ${sectionIndex + 1}` : ''}`);
        }

        // Event listeners cho nút prev/next
        if (prevChapterBtn) {
            prevChapterBtn.addEventListener('click', function () {
                loadChapter(currentChapterIndex - 1);
            });
        }

        if (nextChapterBtn) {
            nextChapterBtn.addEventListener('click', function () {
                loadChapter(currentChapterIndex + 1);
            });
        }

        // Keyboard shortcuts: mũi tên trái/phải
        document.addEventListener('keydown', function (e) {
            // Bỏ qua nếu đang focus vào input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                loadChapter(currentChapterIndex - 1);
            }
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                loadChapter(currentChapterIndex + 1);
            }
            // Phím Home để về đầu chương
            if (e.key === 'Home') {
                e.preventDefault();
                const articleWrapper = document.querySelector('.article-wrapper');
                if (articleWrapper) {
                    articleWrapper.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });

        // =====================
        // SCROLL TO TOP BUTTON
        // =====================
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        const articleWrapperScroll = document.querySelector('.article-wrapper');

        if (scrollTopBtn && articleWrapperScroll) {
            // Click để scroll về đầu
            scrollTopBtn.addEventListener('click', function () {
                articleWrapperScroll.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

        // =====================
        // READING PROGRESS (% scroll trong chương)
        // =====================
        const barFill = document.getElementById('barFill');
        const progressBar = document.getElementById('progressBar');
        const scrollProgressText = document.getElementById('scrollProgressText');
        const progressPrevBtn = document.getElementById('progressPrevBtn');
        const progressNextBtn = document.getElementById('progressNextBtn');
        const articleWrapperProgress = document.querySelector('.article-wrapper');

        // Cập nhật trạng thái nút prev/next trên thanh tiến độ
        function updateProgressNavButtons() {
            if (progressPrevBtn) {
                progressPrevBtn.disabled = currentChapterIndex <= 0;
            }
            if (progressNextBtn) {
                progressNextBtn.disabled = currentChapterIndex >= chapters.length - 1;
            }
        }

        // Cập nhật thanh tiến độ (% scroll trong chương hiện tại)
        function updateReadingProgress() {
            if (!articleWrapperProgress) return;

            const scrollTop = articleWrapperProgress.scrollTop;
            const scrollHeight = articleWrapperProgress.scrollHeight - articleWrapperProgress.clientHeight;

            // Tiến độ scroll trong chương (0-100%)
            const scrollProgress = scrollHeight > 0
                ? Math.round((scrollTop / scrollHeight) * 100)
                : 100; // Nếu nội dung ngắn không cần scroll thì coi như 100%

            // Cập nhật thanh bar
            if (barFill) {
                barFill.style.width = scrollProgress + '%';
            }

            // Cập nhật text %
            if (scrollProgressText) {
                scrollProgressText.textContent = scrollProgress + '%';
            }
        }

        // Lưu tiến độ đọc vào localStorage
        function saveReadingProgress() {
            const data = {
                chapterIndex: currentChapterIndex,
                scrollPosition: articleWrapperProgress ? articleWrapperProgress.scrollTop : 0,
                timestamp: Date.now()
            };
            localStorage.setItem('reading-progress-hncmcn', JSON.stringify(data));
        }

        // Khôi phục tiến độ đọc từ localStorage
        function restoreReadingProgress() {
            const saved = localStorage.getItem('reading-progress-hncmcn');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.chapterIndex !== undefined && data.chapterIndex < chapters.length) {
                        currentChapterIndex = data.chapterIndex;

                        // Cập nhật tiêu đề chương
                        if (chapters[currentChapterIndex]) {
                            updateHeadingChip(chapters[currentChapterIndex].title || '');
                        }

                        // Khôi phục scroll position sau khi DOM load xong
                        setTimeout(() => {
                            if (articleWrapperProgress && data.scrollPosition) {
                                articleWrapperProgress.scrollTop = data.scrollPosition;
                            }
                            updateReadingProgress();
                        }, 100);
                    }
                } catch (e) {
                    console.warn('Không thể khôi phục tiến độ đọc:', e);
                }
            }
        }

        // Lắng nghe scroll để cập nhật tiến độ
        let saveTimeout;
        if (articleWrapperProgress) {
            articleWrapperProgress.addEventListener('scroll', function () {
                // Cập nhật tiến độ realtime
                updateReadingProgress();

                // Hiện/ẩn nút scroll to top
                if (scrollTopBtn) {
                    if (this.scrollTop > 200) {
                        scrollTopBtn.classList.add('show');
                    } else {
                        scrollTopBtn.classList.remove('show');
                    }
                }

                // Lưu tiến độ (debounce)
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveReadingProgress, 500);
            });
        }

        // Click vào thanh tiến độ để nhảy đến vị trí
        if (progressBar && articleWrapperProgress) {
            progressBar.addEventListener('click', function (e) {
                const rect = this.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;

                const scrollHeight = articleWrapperProgress.scrollHeight - articleWrapperProgress.clientHeight;
                articleWrapperProgress.scrollTo({
                    top: scrollHeight * percentage,
                    behavior: 'smooth'
                });
            });
        }

        // Nút prev/next trên thanh tiến độ
        if (progressPrevBtn) {
            progressPrevBtn.addEventListener('click', function () {
                loadChapter(currentChapterIndex - 1);
            });
        }

        if (progressNextBtn) {
            progressNextBtn.addEventListener('click', function () {
                loadChapter(currentChapterIndex + 1);
            });
        }

        // Render mục lục tự động và khởi tạo
        (async () => {
            await renderTOC();

            // Khởi tạo trạng thái ban đầu
            restoreReadingProgress();
            updateChapterNavButtons();
            updateProgressNavButtons();
            updateReadingProgress();
            highlightTocItem(currentChapterIndex);

            // Load chương đầu tiên khi trang load
            loadChapter(currentChapterIndex);
        })();
    });
</script>

</html>